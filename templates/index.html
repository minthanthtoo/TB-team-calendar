<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TB Team Cycle Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <meta name="theme-color" content="#0ea5e9" />
    <link
      rel="apple-touch-icon"
      href="https://cdn-icons-png.flaticon.com/512/3063/3063176.png"
    />
  </head>
  <body>
    <header>
      <h1>
        <span style="font-size: 1.5rem; margin-right: 0.5rem">üè•</span>
        TB Team Cycle Tracker
      </h1>
      <div style="display: flex; flex-direction: column; align-items: flex-end">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
          "
        >
          <!-- Teams Button -->
          <button
            id="teamsBtn"
            style="
              border: none;
              background: #ecfdf5;
              color: #059669;
              font-size: 0.75rem;
              font-weight: 600;
              padding: 2px 8px;
              border-radius: 12px;
              cursor: pointer;
              display: flex;
              gap: 4px;
              position: relative;
            "
          >
            üë• Teams
            <span id="teamRequestBadge" style="display:none; position:absolute; top:-2px; right:-2px; width:8px; height:8px; background:#ef4444; border-radius:50%; border:1px solid white;"></span>
          </button>

          <!-- Sync Button -->
          <button
            id="wifiSyncBtn"
            style="
              border: none;
              background: #f1f5f9;
              color: var(--text-main);
              font-size: 0.75rem;
              font-weight: 600;
              padding: 2px 8px;
              border-radius: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 4px;
            "
          >
            üì° WiFi Sync
          </button>
          <!-- Sync Status Button -->
          <button
            id="syncBtn"
            class="sync-btn sync-idle"
            title="Last Synced: Just now"
            onclick="triggerSync(true)"
          >
            <span class="sync-icon">üîÑ</span>
            <span id="syncText">Synced</span>
          </button>
        </div>
        <div style="font-size: 0.85rem; color: #475569; font-weight: 500">
          <span id="headerCount">{{ patients|length }}</span> PatientRecords
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Dashboard Summary -->
      <div class="dashboard-grid">
        <div
          class="stat-card stat-total"
          id="totalPatientsCard"
          onclick="openPatientList('all')"
        >
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <div class="stat-label">Total Patients</div>
            <div class="stat-value" id="totalCount">{{ patients|length }}</div>
          </div>
        </div>
        <div
          class="stat-card stat-active"
          id="activeCard"
          onclick="openPatientList('active')"
        >
          <div class="stat-icon">üíä</div>
          <div class="stat-content">
            <div class="stat-label">Active Treatment</div>
            <div class="stat-value" id="activeCount">
              {% set active_count = 0 %} {% for p in patients %} {% set
              active_count = active_count + 1 %} {% endfor %} {{ active_count }}
            </div>
          </div>
        </div>
        <div
          class="stat-card stat-cured"
          id="outcomesCard"
          onclick="openPatientList('completed')"
        >
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-label">Outcomes (Cured)</div>
            <div class="stat-value" id="curedCount">0</div>
          </div>
        </div>
      </div>

      <!-- Collapsible Patient Form -->
      <div
        class="card"
        style="
          padding: 0;
          overflow: hidden;
          border: none;
          background: transparent;
          box-shadow: none;
        "
      >
        <button id="toggleFormBtn" class="btn toggle-btn">
          <span><span style="margin-right: 8px">+</span> Add New Patient</span>
          <span class="icon-toggle">‚ñº</span>
        </button>

        <form
          id="patientForm"
          method="POST"
          action="/add_patient"
          class="card"
          style="margin-top: 10px"
        >
          <h3 style="color: var(--primary)">New Patient Enrollment</h3>
          <input type="hidden" id="patient_team_id" name="team_id" value="" />

          <div class="form-grid">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="e.g. U Ba"
                required
              />
            </div>
            <div class="form-group">
              <label for="age">Age</label>
              <input
                type="number"
                id="age"
                name="age"
                placeholder="45"
                required
              />
            </div>
            <div class="form-group">
              <label for="sex">Sex</label>
              <select id="sex" name="sex">
                <option>Male</option>
                <option>Female</option>
              </select>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="address">Address / Contact</label>
              <input
                type="text"
                id="address"
                name="address"
                placeholder="Village / Phone"
              />
            </div>
            <div class="form-group">
              <label for="regime">Treatment Regime</label>
              <select id="regime" name="regime">
                <option value="IR">IR (Intensive Phase)</option>
                <option value="CR">CR (Continuation Phase)</option>
                <option value="RR">RR (Retreatment)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Cycle Timeline</label>
              <div
                id="milestonesPreview"
                style="
                  padding: 0.6rem;
                  background: #f1f5f9;
                  color: #475569;
                  border-radius: 6px;
                  font-size: 0.85rem;
                "
              >
                Loading...
              </div>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="start_date">Provisional Start Date</label>
              <input type="date" id="start_date" name="start_date" required />
            </div>
            <div class="form-group" style="flex: 2">
              <label for="remark">Clinical Notes</label>
              <input
                type="text"
                id="remark"
                name="remark"
                placeholder="History, comorbidities..."
              />
            </div>
          </div>

          <div
            style="
              text-align: right;
              margin-top: 1rem;
              border-top: 1px solid #e2e8f0;
              padding-top: 1rem;
            "
          >
            <button type="submit" class="btn">Confirm Enrollment</button>
          </div>
        </form>
      </div>

      <!-- MAIN LAYOUT (Calendar + Sidebar) -->
      <div class="main-layout">
        <!-- Calendar Section -->
        <div id="calendar-view-wrapper" class="scrollable-calendar-view">
          <div id="calendar-container" style="position: relative;">
            <div id="calendar"></div>
            <div id="year-summary-grid" style="display: none;"></div>
          </div>
          <div class="scroll-nav-controls">
            <button class="scroll-nav-btn" onclick="scrollToTop('calendar-view-wrapper')" title="Scroll to Top">‚Üë</button>
            <button class="scroll-nav-btn" onclick="scrollToBottom('calendar-view-wrapper')" title="Scroll to Bottom">‚Üì</button>
          </div>
        </div>

        <!-- Legend / Patient Registry Sidebar -->
        <div class="card" id="legend">
          <h4
            style="
              margin-bottom: 0.5rem;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            Patient Registry
          </h4>
          <div style="position:relative; margin-bottom:1rem;">
            <input
              type="text"
              id="registrySearch"
              placeholder="Search patients..."
              style="
                width: 100%;
                padding: 8px 12px;
                padding-left: 35px;
                border-radius: 20px;
                border: 1px solid #e2e8f0;
                font-size: 0.9rem;
              "
            />
            <span
              style="
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: #94a3b8;
              "
              >üîç</span
            >
          </div>

            <div
            style="
              padding: 1rem 1.25rem;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 1px solid #f1f5f9;
            "
          >
            <span style="font-size: 0.85rem; color: #475569; font-weight: 600;">üá≤üá≤ Myanmar Lunar Details</span>
            <label class="switch">
              <input type="checkbox" id="toggleMyanmarDetails" onchange="if(window.calendar) window.calendar.refetchEvents();" />
              <span class="slider round"></span>
            </label>
          </div>

          <ul id="registryList">
            {% for p in patients %} {% if p.events %}
            <li
              class="patient-item"
              data-name="{{ p.name|lower }}"
              data-uid="{{ p.uid }}"
              data-start="{{ p.events[0].start if p.events else '' }}"
              data-regime="{{ p.regime }}"
              style="border-left-color: {{ p.events[0].color if p.events else '#cbd5e1' }}"
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-start;
                "
              >
                <div style="flex: 1">
                  <strong
                    onclick="openPatientDetail('{{ p.uid }}')"
                    class="patient-name-link"
                  >
                    {{ p.name }} <span class="info-icon">‚ìò</span>
                  </strong>
                  <div class="patient-meta">
                    Age: {{ p.age }} ‚Ä¢ {{ p.sex }} ‚Ä¢ {{ p.regime }}
                  </div>
                </div>
                <div class="patient-status" id="status-{{ p.uid }}">
                  {% set last_event = p.events|sort(attribute='start')|last %}
                  {% if not last_event or not last_event.outcome %}
                  <span class="badge badge-active">Active</span>
                  {% else %} {% set out = last_event.outcome %}
                  <span
                    class="badge"
                    style="background: {{ '#dcfce7' if out in ['Cured', 'Completed'] else '#fee2e2' }}; color: {{ '#166534' if out in ['Cured', 'Completed'] else '#991b1b' }};"
                    >{{ out }}</span
                  >
                  {% endif %}
                </div>
              </div>

              <div class="progress-container" style="margin-top: 10px">
                <div class="progress-bar-bg">
                  <div
                    class="progress-bar-fill"
                    id="progress-{{ p.uid }}"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="progress-label" id="progress-text-{{ p.uid }}">
                  Calculating...
                </div>
              </div>

              <div
                style="
                  margin-top: 10px;
                  display: flex;
                  justify-content: flex-end;
                "
              >
                <button
                  class="deletePatientBtn btn-text-danger"
                  data-id="{{ p.id }}"
                >
                  ‚úï Remove
                </button>
              </div>
            </li>
            {% endif %} {% endfor %}
          </ul>
          {% if not patients %}
          <div style="text-align: center; padding: 2rem; color: #475569">
            <div style="font-size: 2rem; margin-bottom: 0.5rem">üì≠</div>
            No patients currently enrolled.
          </div>
          {% endif %}
        </div>
      </div>
      <!-- End Main Layout -->
    </div>
    <!-- End Container -->

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Teams Modal -->
    <div
      id="teamsModal"
      class="modal-overlay"
      style="z-index: 1050; display: none"
    >
      <div
        class="modal-content"
        style="
          max-height: 80vh;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-header">
          <h4>Team Management</h4>
          <button id="closeTeamsModal" class="close-btn">&times;</button>
        </div>
        
        <!-- TABS -->
        <div style="display: flex; border-bottom: 1px solid #e2e8f0; padding: 0 1.5rem;">
            <button class="team-tab-btn active" onclick="switchTeamTab('my-team')" style="background:none; border:none; padding: 1rem; border-bottom: 2px solid #0f172a; font-weight:600; color:#0f172a; cursor:pointer;">My Team</button>
            <button class="team-tab-btn" onclick="switchTeamTab('directory')" style="background:none; border:none; padding: 1rem; border-bottom: 2px solid transparent; color:#64748b; cursor:pointer;">Directory</button>
        </div>

        <div style="padding: 1.5rem; overflow-y: auto; height: 400px;">
          
          <!-- TAB 1: MY TEAM -->
          <div id="tab-my-team" style="display:block;">
          
              <!-- Current Team Status -->
              <div
                id="currentTeamSection"
                style="
                  background: #f8fafc;
                  border: 1px solid #e2e8f0;
                  padding: 1.5rem;
                  border-radius: 12px;
                  margin-bottom: 2rem;
                  text-align: center;
                "
              >
                <!-- ... Content ... -->
                <div style="font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                  Active Workspace
                </div>
                <div style="font-size: 1.5rem; font-weight: 800; color: #0f172a; margin: 0.5rem 0;" id="myTeamDisplay">
                  Default (Guest)
                </div>
                <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;" id="myTeamDesc">
                  You are viewing local data only.
                </div>
                <!-- Action Buttons (Injected) -->
                <div id="teamActionsContainer"></div>
              </div>

              <!-- Other Workspaces switcher -->
              <div style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
                  <h5 style="color: #475569; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center;">
                      Other Workspaces
                      <button onclick="loadTeams()" style="background:none; border:none; color:#0f172a; cursor:pointer; font-size:0.9rem;" title="Refresh">‚Üª</button>
                  </h5>
                  <div id="myTeamsList" style="display:flex; flex-direction:column; gap:8px;"></div>
              </div>
            
              <!-- Management Sections (Admin Only) -->
              <div id="adminPendingSection" style="margin-top: 1.5rem; display: none;">
                  <h5 style="color: #0f172a; font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;">Pending Requests</h5>
                  <div id="pendingMembersList" style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"></div>
              </div>

              <div id="adminActiveSection" style="margin-top: 1.5rem; display: none;">
                  <h5 style="color: #0f172a; font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;">Active Members</h5>
                  <div id="activeMembersList" style="background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;"></div>
              </div>
          </div>

          <!-- TAB 2: DIRECTORY -->
          <div id="tab-directory" style="display:none;">
              
              <div class="form-section-title" style="margin-top: 0; display:flex; justify-content:space-between; align-items:center;">
                  <span>üåê Public Directory</span>
                  <button onclick="loadTeams()" style="background:#f1f5f9; border:1px solid #e2e8f0; border-radius:4px; padding:2px 8px; cursor:pointer;">‚Üª Refresh</button>
              </div>
              
              <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                  <input type="text" id="searchTeamInput" placeholder="Search teams..." class="form-control" style="flex:2;">
                  <select id="teamSortSelect" class="form-control" style="flex:1.5; font-size: 0.85rem;" onchange="loadTeams()">
                      <option value="alphabet">A-Z</option>
                      <option value="created">Newest</option>
                      <option value="active">Active</option>
                      <option value="count">Members</option>
                  </select>
              </div>
              
              <div id="publicTeamsList" style="max-height: 250px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px;">
                  <div style="padding: 1rem; text-align: center; color: #94a3b8">Loading...</div>
              </div>
              
              <!-- Pagination -->
              <div id="teamPagination" style="display:none; justify-content:center; align-items:center; gap:10px; margin-bottom: 1.5rem;">
                  <button class="btn" style="padding: 2px 8px; background:white; border:1px solid #cbd5e1;" id="prevTeamPage" onclick="changePublicPage(-1)">‚Üê</button>
                  <span id="teamPageInfo" style="font-size:0.85rem; color:#475569; font-weight:600;">Page 1 / 1</span>
                  <button class="btn" style="padding: 2px 8px; background:white; border:1px solid #cbd5e1;" id="nextTeamPage" onclick="changePublicPage(1)">‚Üí</button>
              </div>
              
              <!-- Join Existing -->
              <div style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                  <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: #334155;">Have an Invite Code?</div>
                  <div style="display: flex; gap: 8px;">
                     <input type="text" id="joinTeamCode" placeholder="XXX-XXX" class="form-control" style="text-transform: uppercase; letter-spacing: 2px; font-weight: 700; text-align: center; width: 150px;">
                     <button class="btn" style="white-space: nowrap;" onclick="joinTeamByCode()">Join</button>
                  </div>
                  <div id="joinCodePreview" style="font-size: 0.75rem; margin-top: 6px; font-weight: 600;"></div>
              </div>
              
              <!-- Create -->
              <div style="border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                  <div class="form-section-title">üöÄ Launch New Team</div>
                  <div style="background: white; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 8px;">
                    <input type="text" id="newTeamName" placeholder="e.g. Mandalay Clinic" class="form-control" style="margin-bottom: 8px; font-weight: 600;">
                    <div style="margin-bottom: 12px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="newTeamPublic" style="width:auto;">
                        <label for="newTeamPublic" style="font-size:0.85rem; color:#475569; font-weight:normal;">Public (Listed in Directory)</label>
                    </div>
                    <button class="btn" id="createTeamBtn" style="width: 100%;">Create Team</button>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Modal (Dialog) -->
    <div id="eventModal" class="modal-overlay" style="z-index: 1010">
      <div class="modal-content">
        <div class="modal-header">
          <h4 id="modalTitle">Milestone Details</h4>
          <button id="closeModal" class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modalDetails"></div>
          <!-- Dynamic Content injected by JS -->
        </div>
      </div>
    </div>

    <!-- WiFi Sync Modal -->
    <div id="syncModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 550px">
        <div class="modal-header">
          <h4 id="modalTitle">üì° Team WiFi Sync</h4>
          <button id="closeSyncModal" class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Tabs -->
          <div
            style="
              display: flex;
              border-bottom: 1px solid var(--border-color);
              margin-bottom: 1.5rem;
            "
          >
            <button class="tab-btn active" data-tab="host">
              I am the HOST
            </button>
            <button class="tab-btn" data-tab="guest">I am a GUEST</button>
          </div>

          <!-- HOST CONTENT -->
          <div id="hostTab" class="tab-content active">
            <h4 style="margin-bottom: 0.5rem; color: var(--primary)">
              I am the HOST
            </h4>
            <div class="alert-box">
              <p style="margin-bottom: 0.25rem; font-size: 0.9rem">
                Your Local IP Address:
              </p>
              <code
                style="
                  font-size: 1.2rem;
                  font-weight: bold;
                  display: block;
                  margin-bottom: 0.5rem;
                "
                >{{ share_url }}</code
              >
              <p
                id="hostNameDisplay"
                style="
                  font-size: 0.8rem;
                  color: var(--text-muted);
                  text-align: right;
                "
              >
                Host: ...
              </p>
            </div>

            <h5 style="margin-top: 1rem; margin-bottom: 0.5rem">
              Joined Devices
            </h5>
            <div
              id="connectedDevicesList"
              style="
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 10px;
                min-height: 60px;
                margin-bottom: 1rem;
                font-size: 0.85rem;
                color: #64748b;
              "
            >
              <span class="spinner"></span> Waiting for connections...
            </div>

            <h5 style="margin-bottom: 0.5rem">Incoming Updates</h5>
            <p
              style="
                font-size: 0.8rem;
                color: var(--text-muted);
                margin-bottom: 0.5rem;
              "
            >
              Check if team members have pushed data to you.
            </p>

            <button
              id="checkUpdatesBtn"
              class="btn btn-secondary"
              onclick="checkIncoming()"
              style="width: 100%; margin-bottom: 1rem"
            >
              üîÑ Check for Updates
            </button>
            <div id="reviewContainer"></div>
          </div>

          <!-- GUEST CONTENT -->
          <div id="guestTab" class="tab-content" style="display: none">
            <h4 style="margin-bottom: 0.5rem; color: var(--secondary)">
              I am a GUEST
            </h4>

            <div class="form-group">
              <label>My Device Name</label>
              <input
                type="text"
                id="myDeviceName"
                class="form-control"
                placeholder="e.g. Dr. Aung's Tablet"
              />
            </div>

            <div class="form-group">
              <label>Host IP Address</label>
              <div style="display: flex; gap: 0.5rem">
                <input
                  type="text"
                  id="hostIpInput"
                  class="form-control"
                  placeholder="e.g. 192.168.1.5"
                  style="flex: 1"
                />
                <button
                  id="findHostBtn"
                  class="btn btn-secondary"
                  style="white-space: nowrap; padding: 0 1rem"
                  onclick="findHostServer()"
                >
                  üîç Find Server
                </button>
              </div>
              <div
                id="scanStatus"
                style="
                  font-size: 0.8rem;
                  color: var(--text-muted);
                  margin-top: 4px;
                  display: none;
                "
              >
                Scanning network...
                <span class="spinner" style="width: 12px; height: 12px"></span>
              </div>
            </div>

            <div
              id="guestActions"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem"
            >
              <div
                style="
                  border: 1px solid var(--border-color);
                  padding: 1rem;
                  border-radius: 8px;
                "
              >
                <strong
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--primary);
                  "
                  >üì• Pull Data</strong
                >
                <button
                  class="btn btn-secondary"
                  style="width: 100%; margin-bottom: 0.5rem; font-size: 0.8rem"
                  onclick="fetchFromHost('append')"
                >
                  Append to My List
                </button>
                <button
                  class="btn btn-danger"
                  style="width: 100%; font-size: 0.8rem"
                  onclick="if(confirm('Replace ALL local data with Host data?')) fetchFromHost('replace')"
                >
                  Replace All
                </button>
              </div>

              <div
                style="
                  border: 1px solid var(--border-color);
                  padding: 1rem;
                  border-radius: 8px;
                "
              >
                <strong
                  style="
                    display: block;
                    margin-bottom: 0.5rem;
                    color: var(--success);
                  "
                  >üì§ Push Data</strong
                >
                <p
                  style="
                    font-size: 0.75rem;
                    color: var(--text-muted);
                    margin-bottom: 0.5rem;
                  "
                >
                  Send my records to Host for review.
                </p>
                <button
                  class="btn"
                  style="width: 100%; background: var(--success)"
                  onclick="pushToHost()"
                >
                  Push to Host
                </button>
              </div>
            </div>

            <div
              id="connectionStatus"
              style="
                font-size: 0.9rem;
                margin-top: 1rem;
                font-weight: 600;
                text-align: center;
              "
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmDeleteModal" class="modal-overlay">
      <div
        class="modal-content"
        style="max-width: 400px; text-align: center; padding-bottom: 2rem"
      >
        <div class="modal-body">
          <div style="font-size: 3rem; margin-bottom: 1rem">‚ö†Ô∏è</div>
          <h3 style="color: var(--danger); margin-bottom: 0.5rem">
            Remove Patient?
          </h3>
          <p style="color: var(--text-muted); margin-bottom: 2rem">
            Are you sure you want to delete
            <strong
              id="deletePatientName"
              style="color: var(--text-main)"
            ></strong
            >? <br />This action cannot be undone.
          </p>
          <div style="display: flex; justify-content: center; gap: 1rem">
            <button id="cancelDeleteBtn" class="btn btn-secondary">
              Cancel
            </button>
            <button
              id="confirmDeleteBtn"
              class="btn"
              style="background-color: var(--danger)"
            >
              Yes, Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Patient List Modal -->
    <div id="patientListModal" class="modal-overlay">
      <div
        class="modal-content"
        style="
          max-width: 600px;
          height: 80vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-header">
          <h3 id="patientListTitle">All Patients</h3>
          <span class="close-modal" id="closePatientList">&times;</span>
        </div>
        <div
          style="
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
          "
        >
          <input
            type="text"
            id="patientSearch"
            placeholder="üîç Search by name..."
            style="
              width: 100%;
              padding: 8px;
              border: 1px solid #e2e8f0;
              border-radius: 6px;
              margin-bottom: 8px;
            "
          />
          <div style="display: flex; gap: 8px; margin-bottom: 8px">
            <select
              id="patientFilter"
              style="
                flex: 1;
                padding: 6px;
                border-radius: 6px;
                border: 1px solid #e2e8f0;
              "
            >
              <option value="all">All Status</option>
              <option value="active">Active Treatment</option>
              <option value="completed">Completed / Cured</option>
              <option value="outcome">Has Outcome</option>
            </select>
            <input
              type="month"
              id="patientMonthFilter"
              style="
                flex: 1;
                padding: 6px;
                border-radius: 6px;
                border: 1px solid #e2e8f0;
              "
            />
          </div>
          <div style="display: flex; gap: 8px">
            <select
              id="patientSort"
              style="
                flex: 1;
                padding: 6px;
                border-radius: 6px;
                border: 1px solid #e2e8f0;
              "
            >
              <option value="name">Sort: Name (A-Z)</option>
              <option value="age">Sort: Age</option>
              <option value="newest">Sort: Newest</option>
            </select>
          </div>
          <div
            id="patientListCount"
            style="
              padding: 4px 0 0 2px;
              font-size: 0.85rem;
              color: #64748b;
              font-weight: 500;
            "
          ></div>
        </div>
        <div
          id="patientListContainer"
          style="flex: 1; overflow-y: auto; padding: 0"
        >
          <!-- List injected by JS -->
        </div>
      </div>
    </div>

    <!-- Patient Detail Modal -->
    <div id="patientDetailModal" class="modal-overlay" style="z-index: 1002">
      <div
        class="modal-content"
        style="max-width: 500px; max-height: 90vh; overflow-y: auto"
      >
        <div
          class="modal-header"
          style="background: var(--primary); color: white"
        >
          <h3 id="pdName">Patient Details</h3>
          <span class="close-modal" id="closePatientDetail" style="color: white"
            >&times;</span
          >
        </div>
        <div id="pdContent" style="padding: 15px">
          <div
            id="pdHeader"
            style="
              display: flex;
              gap: 10px;
              margin-bottom: 20px;
              border-bottom: 1px solid #eee;
              padding-bottom: 15px;
            "
          ></div>

          <div
            class="section-title"
            style="
              font-weight: 600;
              color: #475569;
              border-bottom: 2px solid #e2e8f0;
              margin-bottom: 10px;
              padding-bottom: 4px;
            "
          >
            Treatment Timeline
          </div>
          <div id="pdTimeline"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="{{ url_for('static', filename='mmcal.js') }}"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("{{ url_for('static', filename='sw.js') }}")
            .then((reg) => console.log("SW Registered!", reg.scope))
            .catch((err) => console.log("SW Fail:", err));
        });
      }
    </script>
    <!-- Disband Confirmation Modal -->
    <!-- Disband Confirmation Modal -->
    <!-- Disband Confirmation Modal -->
    <div id="disbandModal" class="modal-overlay" style="z-index: 1100; display: none;">
      <div 
        class="modal-content premium-modal"
        style="
            text-align: center; 
            border-radius: 16px;
            border: 1px solid #fecaca;
            box-shadow: 0 25px 50px -12px rgba(239, 68, 68, 0.15);
            display: flex;
            flex-direction: column;
        "
      >
        <div style="flex: 1; overflow-y: auto; padding: 2rem;">
            <!-- Danger Icon -->
            <div style="
                width: 56px; height: 56px; 
                margin: 0 auto 1rem auto; 
                background: #fef2f2; 
                border-radius: 50%; 
                display: flex; align-items: center; justify-content: center;
                color: #ef4444; font-size: 1.75rem;
                animation: pulse-red 2s infinite;
            ">
                ‚ö†Ô∏è
            </div>

            <h3 style="color: #1e293b; font-size: 1.25rem; margin-bottom: 0.5rem; font-weight: 700;">Delete this Team?</h3>
            
            <p style="color: #64748b; font-size: 0.9rem; line-height: 1.4; margin-bottom: 1.25rem;">
              You are about to permanently delete <strong>all data</strong> for this team. This action simply cannot be undone.
            </p>
            
            <!-- Stats Card -->
            <div id="disbandStats" style="
                background: #f8fafc; 
                border: 1px solid #e2e8f0; 
                border-radius: 12px; 
                padding: 0.75rem; 
                margin-bottom: 1.25rem;
                text-align: left;
            ">
              <div style="font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.05em;">
                Data to be removed
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <div class="stat-mini-card">
                      <div class="stat-mini-val" id="statPatients">...</div>
                      <div class="stat-mini-label">Patients</div>
                  </div>
                  <div class="stat-mini-card">
                      <div class="stat-mini-val" id="statEvents">...</div>
                      <div class="stat-mini-label">Events</div>
                  </div>
                  <div class="stat-mini-card">
                      <div class="stat-mini-val" id="statMembers">...</div>
                      <div class="stat-mini-label">Members</div>
                  </div>
                  <div class="stat-mini-card">
                      <div class="stat-mini-val" id="statSize">...</div>
                      <div class="stat-mini-label">Backup Size</div>
                  </div>
              </div>
            </div>

            <div style="background: #fff1f2; padding: 10px; border-radius: 8px; color: #be123c; font-size: 0.8rem; margin-bottom: 1rem; display: flex; align-items: start; gap: 8px; text-align: left;">
                <div style="font-size: 1rem;">üõ°Ô∏è</div>
                <div style="line-height: 1.3">
                    <strong>Safety First:</strong> A full .json backup will be automatically downloaded before deletion starts.
                </div>
            </div>
        </div>

        <!-- Sticky Footer for Buttons -->
        <div style="
            padding: 1.25rem; 
            border-top: 1px solid #f1f5f9; 
            background: white; 
            display: flex; 
            gap: 10px; 
            justify-content: stretch;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        ">
          <button
            class="btn"
            style="background: white; color: #64748b; border: 1px solid #cbd5e1; flex: 1; padding: 12px; font-size: 0.9rem;"
            onclick="document.getElementById('disbandModal').style.display='none'"
          >
            Cancel
          </button>
          <button 
            id="confirmDisbandBtn" 
            class="btn" 
            style="background: #ef4444; color: white; flex: 2; border: none; font-weight: 600; padding: 12px; font-size: 0.9rem; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);"
          >
            Delete Team
          </button>
        </div>
      </div>
    </div>
    
    <!-- Access Denied Modal -->
    <div id="accessDeniedModal" class="modal-overlay" style="display:none; z-index: 10000; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
      <div class="premium-modal" style="border: 2px solid #ef4444; text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">‚õî</div>
        <h2 style="color: #1e293b; margin-bottom: 0.5rem; font-weight: 800;">Access Denied</h2>
        <p id="accessDeniedMessage" style="color: #64748b; margin-bottom: 2rem;">
          You don't have permission to access this team workspace. You may have been removed or your request was rejected.
        </p>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="location.reload()" class="btn" style="background: #0f172a; color:white; width: 100%; padding: 12px; font-weight: 600;">
            Try Refreshing
          </button>
          <button onclick="document.getElementById('accessDeniedModal').style.display='none'; localStorage.removeItem('tb_team_slug'); localStorage.removeItem('tb_team_name'); location.reload();" class="btn" style="background: white; border: 1px solid #cbd5e1; color: #475569; width: 100%; padding: 12px; font-weight: 600;">
            Switch to Guest Mode
          </button>
          <button onclick="document.getElementById('accessDeniedModal').style.display='none'; teamsModal.style.display='flex'; loadTeams();" class="btn" style="background: #f8fafc; color: #1e293b; border: 1px solid #e2e8f0; width: 100%; padding: 12px; font-weight: 600;">
            View My Teams
          </button>
        </div>
      </div>
    </div>

    <style>
        .premium-modal {
            max-width: 440px;
            width: 90%;
            background: white;
            /* Max height constraints for mobile landscape */
            max-height: 90vh;
        }

        .stat-mini-card {
            background: white; padding: 8px; border-radius: 6px; 
            border: 1px solid #f1f5f9; text-align: center;
        }
        .stat-mini-val { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        .stat-mini-label { font-size: 0.7rem; color: #64748b; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Mobile Optimization */
        @media (max-width: 480px), (max-height: 600px) {
            .premium-modal {
                width: 95%;
                max-height: 95vh;
            }
            .premium-modal h3 { font-size: 1.1rem; }
            .premium-modal p { font-size: 0.85rem; }
            
            /* Compact list in landscape */
            .stat-mini-card { padding: 4px; }
            .stat-mini-val { font-size: 1rem; }
        }
    </style>
  </body>
</html>
